# 升级合集

## 通用升级

### 通用升级列表

| 品质 | 名称 | ID | 效果 | 最大等級（MaxLevel） | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 暴击强化 | `crit_rate` | 暴击率 +3lv% | -1 | 强化 |
| 白 | 暴伤强化 | `crit_damage` | 暴击伤害 +10lv% | -1 | 强化 |
| 白 | 伤害强化 | `damage_bonus` | 伤害 +5lv% | -1 | 强化 |
| 白 | 耐久强化 | `health` | 耐久上限 +5lv | -1 | 强化 |
| 蓝 | 地雷 | `mine` | 每{冷却时间}秒放置一个地雷，接触敌人后对{爆炸范围}范围内敌人造成{基础伤害=5lv}点伤害。部署上限：10+5lv | 4 | 配件 |
| 白 | 地雷·范围 | `mine_range` | 地雷爆炸范围+5lv米 | 5 | 强化（专属） |
| 白 | 地雷·冷却 | `mine_cooldown` | 地雷冷却时间-15lv% | 5 | 强化（专属） |
| 紫 | 地雷·反甲 | `mine_anti_armor` | 地雷冷却时间+5秒，地雷基础伤害+200lv%。地雷仅能由精英或BOSS触发 | 5 | 强化（专属） |
| 红 | 配件冷却 | `accessory_cooldown` | 所有配件冷却时间缩短10lv% | 3 | 配件 |


### 系统说明
- **耐久**：即health，影响玩家的最大生命值
- **全局暴击率**：影响所有武器和配件的暴击率
- **伤害加成**：作用在计算护甲之前，在 `_compute_bullet_damage()` 中先乘以伤害加成
- **伤害类型**：
  - 武器伤害（子弹伤害）：白色，伤害类型为 `"weapon"`
  - 武器暴击伤害：黄色，伤害类型为 `"critical"`
  - 配件伤害：默认白色，伤害类型为 `"accessory"`（地雷等配件的伤害）
  - 配件暴击伤害：黄色，伤害类型为 `"accessory_critical"`（配件暴击时）
  - 流血伤害：绯红色，伤害类型为 `"bleed"`

---

## 主武器强化（通用）

### 射速类强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 白 | 速射 | `rapid_fire` | 射速 +5lv% | -1 | 强化 |
| 蓝 | 连射 | `chain_fire` | 射速 -5lv%。主武器射击时，+3%射速，最多叠加4lv层，每1秒减少1层 | 5 | 强化 |
| 蓝 | 散弹 | `scatter_shot` | 主武器每射击10/8/7/6/5次（随等级递减），向随机方向进行1/1/2/2/3次额外射击 | 5 | 强化 |
| 紫 | 爆射 | `burst_fire` | 主武器暴击时，+4%射速，最多叠加4lv层，每1秒减少1层 | 10 | 强化 |
| 蓝 | 扫射 | `sweep_fire` | +50lv%射速。主武器射击方向变更：顺时针旋转（每帧旋转固定角度） | 2 | 强化 |
| 蓝 | 乱射 | `chaos_fire` | +100%射速。主武器射击方向变更：随机方向（每次射击完全随机） | 1 | 强化 |
| 紫 | 破竹 | `breakthrough` | 场上存在的怪物数量越少，获得越多射速加成，最多+25lv%（怪物数量N，则+25lv%/N射速） | 3 | 强化 |
| 红 | 火力压制 | `fire_suppression` | 自身配件数量越多，获得越多射速加成（配件数量N，则+5lv*N%射速） | 2 | 强化 |

### 穿透/弹道类强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 穿透 | `penetration` | 伤害 -10lv%，主武器穿透+1lv | 5 | 强化 |
| 蓝 | 风车 | `windmill` | 射速 -50%。伤害 -20/30/40%（随等级）。主武器弹道+2/3/4。主武器射击方向变更：顺时针旋转 | 3 | 强化 |
| 紫 | 弹射 | `ricochet` | 主武器子弹命中后，有(10+10lv)%概率向最近敌人弹射。弹射在穿透前判定，成功则不消耗穿透次数 | 4 | 强化 |
| 红 | 扩散 | `spread_shot` | 主武器弹道+1/2/3，每发子弹造成50%/40%/30%伤害 | 3 | 强化 |
| 红 | 分裂 | `split_shot` | 主武器暴击时，子弹分裂成2/3发（随等级），每发造成50%伤害。仅在弹射失败时触发，不消耗穿透次数。分裂子弹无法再分裂 | 2 | 强化 |

### 暴击类强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 紫 | 屏息 | `breath_hold` | 主武器未进行射击时，以+10lv%/秒的速率给予暴击伤害加成。主武器射击后清空所有加成 | 10 | 强化 |
| 紫 | 专注 | `focus` | 主武器连续命中同一敌人时，每发+1lv%暴击率，最多叠加5层。未命中该敌人时重新计算 | 5 | 强化 |
| 紫 | 收割 | `harvest` | 暴击击杀敌人时，恢复1lv点耐久 | 5 | 强化 |
| 红 | 致命一击 | `lethal_strike` | 主武器每射击9/7/5/3次，下一次射击暴击率+100%，且暴击伤害翻倍 | 4 | 强化 |
| 红 | 暴击转换 | `crit_conversion` | 暴击时，暴击率加成会作用于暴击伤害加成 | 1 | 强化 |

---

## 机炮专属强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 机炮·过载 | `mg_overload` | 射速 +50%，主武器射击时，-5/4/3%射速（随等级），最多叠加12/15/20层，每1秒减少1/2/3层 | 3 | 强化（专属） |
| 紫 | 机炮·重弹 | `mg_heavy_round` | 射速 -10lv%，主武器基础伤害+1lv | 5 | 强化（专属） |
| 红 | 机炮·穿甲弹 | `mg_ap_round` | 主武器基础伤害+3，穿透固定为1 | 1 | 强化（专属） |

---

## 机炮基础数据

### 基础属性

- **基础伤害**：4
- **初始弹道数**：1（每次射击发出 `spread_count` 发）
- **射速（基础）**：300 发/分钟
- **弹速**：900
- **穿透次数**：0
- **弹道扩散**：每枚子弹约 ±3° 角度
- **溅射**：0（默认不产生额外连锁伤害）
- **流血层数**：0（暴击后附加的流血层）
- **每层流血伤害**：1 （每移动 1 米造成 1 点伤害并减少一层）

---

## 系统说明与实现要点

### 1. 伤害加成计算位置
- **伤害+5%类词条**：作用在计算护甲之前
- 在 `_compute_bullet_damage()` 中先乘以伤害加成，然后再进行护甲计算

### 2. 射击方向变更机制
- **扫射/风车（顺时针旋转）**：每帧旋转固定角度（在 `_process()` 中持续旋转）
- **乱射（随机方向）**：每次射击时完全随机方向（在 `on_timer_timeout()` 中生成）
- **不兼容规则**：选择其中一个后，从强化池删除其他拥有不同方向变更的强化/配件
  - 例如：选择扫射（顺时针）后，乱射（随机）被删除，但风车（也是顺时针）保留

### 3. 屏息机制
- **计时方式**：维护一个计时器，从上次射击开始计时
- **加成计算**：加成 = 未射击时间（秒）× 10lv% / 秒
  - 例如：0.5秒未射击 = 5lv%加成，1秒 = 10lv%，2秒 = 20lv%
- **重置**：每次射击时重置计时器为0，清空所有加成

### 4. 弹射机制
- **判定时机**：在穿透判定前进行
- **判定条件**：若附近没有敌人（攻击范围内没有敌人，子弹攻击范围半径继承自发射者），则直接判定不弹射
- **成功效果**：若判定成功，进行弹射且不消耗穿透次数

### 5. 分裂机制
- **触发时机**：在弹射判定失败后立刻触发（若无弹射强化，则命中后立刻触发）
- **不消耗穿透**：分裂不消耗穿透次数
- **复制方式**：分裂的子弹复制自原子弹（复制当前状态，特别是 `_hit_hurtboxes` 数组，避免立即命中同一目标）
- **伤害修改**：分裂的子弹伤害按照强化描述修改（50%伤害）
- **分裂标签**：分裂的子弹拥有分裂标签，无法再触发分裂

### 6. 属性系统变更
- **不再区分**：大部分全局属性和主武器属性（例如射速、暴击率等）
- **仍有区别**：
  - 主武器基础伤害 vs 配件基础伤害
  - 主武器穿透 vs 配件穿透
- **未来扩展**：以后有的配件可能不会吃到满射速加成

### 7. 专属强化
- **前缀标识**：类似"机炮·"、"地雷·"前缀的强化为专属强化
- **出现条件**：只有在玩家拥有相应的主武器、配件时才会在强化池中出现
- **动态加入池子**：当玩家选择地雷配件后，地雷专属强化（`mine_range`、`mine_cooldown`、`mine_anti_armor`）会被动态加入升级池；当玩家装备机炮后，机炮专属强化（`mg_overload`、`mg_heavy_round`、`mg_ap_round`）会被动态加入升级池

### 8. 敌人数量获取
- 使用 `get_tree().get_nodes_in_group("enemy")` 获取场上所有敌人
- 参考 `machine_gun_ability_controller.gd` 中的实现

### 9. 配件数量获取
- 通过 `GameManager.get_vehicle_config()` 获取车辆配置
- 通过 `vehicle_config.get("配件")` 获取配件数组
- 配件数量 = 配件数组的长度

### 10. 流血处理
- 暴击后会在目标身上添加 `BleedEffect` 节点
- 每移动 1 米造成 `bleed_damage_per_layer` 点伤害，并减少一层
- 层数为 `bleed_layers`

### 11. 配件系统
- **配件类型**：配件分为两类
  - **强化型配件**：如"配件冷却"，效果类似强化，无独立实体
  - **副武器型配件**：如"地雷"，有独立实体和行为，类似副武器
- **配件获得**：局内升级时选择配件，若未拥有则获得（等级1），若已拥有则升级（等级+1）
- **配件伤害**：默认走护甲计算，伤害类型为 `"accessory"`，暴击相关与主武器类似（全局暴击率、暴击伤害等）
- **配件专属强化**：只有拥有对应配件时，其专属强化才会出现在升级池中

### 12. 地雷配件机制
- **基础属性**：
  - 基础冷却时间：待配置（建议初始值）
  - 基础爆炸范围：待配置（建议初始值）
  - 基础伤害：5×等级
  - 部署上限：10+5×等级
- **部署机制**：
  - 每{冷却时间}秒自动在玩家位置放置一个地雷
  - 地雷为 `Area2D` 节点，敌人进入范围时触发爆炸
  - 到达部署上限时，自动触发最早部署的地雷爆炸，然后放置新地雷
- **专属强化效果**：
  - `mine_range`：爆炸范围 +5×等级 米
  - `mine_cooldown`：冷却时间 -15×等级%
  - `mine_anti_armor`：冷却时间 +5秒，基础伤害 +200×等级%，仅精英/BOSS可触发
- **全局配件冷却**：`accessory_cooldown` 配件会缩短所有配件的冷却时间（-10×等级%）

### 13. 升级池动态管理
- **升级池数据库**：存储所有可用的升级条目（包括专属强化），但不一定都在当前池子中
- **局内升级池**：当前对局中实际可抽取的升级池，会根据以下情况动态调整：
  - 玩家选择配件后，将该配件的专属强化加入局内升级池
  - 玩家装备主武器后，将该主武器的专属强化加入局内升级池
  - 升级达到满级后，从局内升级池中移除
  - 互斥升级选择后，从局内升级池中移除互斥选项
- **抽取逻辑**：`pick_upgrades()` 只从局内升级池中抽取，不再进行过滤

---

## 实现优先级建议

### 简单实现（可直接使用）
1. 速射、精准、暴伤强化、伤害强化（简单数值加成）
2. 机炮·重弹、机炮·穿甲弹（简单数值修改）
3. 收割（监听击杀事件）

### 中等难度（需要一些新逻辑）
1. 连射、爆射（层数叠加系统）
2. 散弹（计数机制）
3. 专注（目标跟踪）
4. 屏息（计时器系统）
5. 致命一击（计数机制）

### 较难实现（需要较大改动）
1. 扫射/风车/乱射（射击方向变更系统）
2. 弹射（碰撞检测和方向计算）
3. 分裂（子弹复制和状态管理）
4. 孤军奋战、火力压制（动态计算）
5. 暴击共鸣（暴击率转暴击伤害）
