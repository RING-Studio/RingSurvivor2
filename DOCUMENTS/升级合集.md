# 升级合集

## 通用升级

声明：射速、装填速度、冷却速度（倍率设计）
    - 三者均以**百分比倍率**表示（如“射速 +5%”“装填速度 +15%”“冷却速度 +15%”），不与具体“每分多少次”强挂钩。
    - 计算实际间隔时：**最终间隔 = 基础间隔 / 速度倍率**，其中 **速度倍率 = 1 + 各加成百分比之和**（与射速一致）。
    - 若速度倍率 ≤ 0，则间隔视为**无穷**（不触发该 timer）。
    - 文档中“装填：10秒 / 冷却：30秒”等表示**基础间隔**；“装填速度 +X% / 冷却速度 +X%”表示对速度的倍率加成。

### 通用升级列表

| 品质 | 名称 | ID | 效果 | 最大等級（MaxLevel） | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 暴击强化 | `crit_rate` | 暴击率 +3lv% | -1 | 强化 |
| 白 | 暴伤强化 | `crit_damage` | 暴击伤害 +6lv% | -1 | 强化 |
| 白 | 伤害强化 | `damage_bonus` | 伤害 +5lv% | -1 | 强化 |
| 白 | 耐久强化 | `health` | 耐久上限 +5lv | -1 | 强化 |
| 蓝 | 地雷 | `mine` | 放置一个地雷，接触敌人后对{爆炸范围=3米}范围内敌人造成{基础伤害=5lv}点伤害。\n装填：3s\n部署上限：10+5lv | 4 | 配件 |
| 蓝 | 地雷·范围 | `mine_range` | 地雷爆炸范围+1.5lv米 | 5 | 强化（专属） |
| 蓝 | 地雷·装填速度 | `mine_cooldown` | 地雷装填速度 +15lv% | 5 | 强化（专属） |
| 紫 | 地雷·布雷 | `mine_multi_deploy` | 地雷基础伤害 -1lv\n每次部署地雷数量 +1lv | 4 | 强化（专属） |
| 紫 | 地雷·AT | `mine_anti_tank` | 地雷装填 +5秒\n地雷基础伤害+200lv%\n地雷仅能由精英或BOSS触发 | 5 | 强化（专属） |
| 红 | 冷却装置 | `cooling_device` | 冷却速度 +15lv%（仅冷却类配件） | 3 | 配件 |

### 通用·生命回复与生存

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 白 | 散热器 | `heat_sink` | 耐久上限越低，全局冷却速度越快\n耐久上限 -5lv\n全局冷却速度 +{初始耐久上限-耐久上限}*0.1lv% | 5 | 强化 |
| 白 | 维护工具箱 | `repair_kit` | 每{冷却}秒回复 1 点耐久\n冷却：15/12/10/9/8/7/6/5/4 | 9 | 强化 |
| 白 | 车载空调 | `cabin_ac` | 回复耐久时，冷却速度 +5lv%，持续3秒。不可叠加。 | 5 | 强化 |

### 通用·移速与机动

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 克里斯蒂悬挂 | `christie_suspension` | 移速 +10lv% | 5 | 强化 |
| 紫 | 燃气轮机 | `gas_turbine` | 移速 +15lv% | 3 | 强化 |
| 紫 | 液气悬挂 | `hydro_pneumatic` | 受到的移速惩罚减半 | 1 | 强化 |

### 通用·伤害与暴击变体

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 先进热成像仪 | `thermal_imager` | 暴击率 +5% | 1 | 强化 |
| 白 | 激光测距仪 | `laser_rangefinder` | 暴击率 +4% | 1 | 强化 |
| 紫 | 半穿甲弹 | `sap_round` | 对无护甲/轻甲敌人伤害 +10lv%，暴击伤害 +30lv% | 5 | 强化 |
| 蓝 | 额外弹药架 | `extra_ammo_rack` | 耐久上限 -5lv，移速 -10%，装填速度 +10lv%，射速 +10lv% | 5 | 强化 |

### 通用·防御与减伤

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 车身附加装甲 | `addon_armor` | 耐久 +4lv，被击穿时受到的伤害减免 5lv% | 5 | 强化 |
| 蓝 | 泄压阀 | `relief_valve` | 被击穿时受到的伤害减免 10lv% | 6 | 强化 |

### 通用·撞击与碰撞（可选实现）

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 白 | 破障设备 | `breach_equip` | 撞击对命中的敌人造成 当前移速×耐久×0.5lv 点伤害 | 4 | 配件 |

### 配件（扩展）

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 烟雾弹 | `smoke_grenade` | 原地释放烟雾，1米范围内敌人移速 -20lv%，持续3秒。装填：10秒 | 5 | 配件 |
| 紫 | 无线电通讯 | `radio_support` | 呼叫炮击锁定随机区域，10秒后在该区域造成不分敌我的范围伤害。基础伤害：50+20lv。范围：20米。冷却：60-5lv秒 | 3 | 配件 |
| 红 | 激光压制 | `laser_suppress` | 开启后5秒内，对5米范围内正在瞄准玩家的最近的远程敌人发射激光，每秒造成5次伤害。基础伤害：4+2lv。冷却：30秒。 | 3 | 配件 |
| 蓝 | 纤维内衬 | `spall_liner` | 被动：抵御一次致命击穿伤害，触发后失效 | 1 | 配件 |
| 紫 | 爆炸反应装甲 | `era_block` | 被动：抵御一次任意致命伤害，触发后失效。可与纤维内衬共存，优先于内衬触发 | 1 | 配件 |
| 紫 | 外挂导弹 | `external_missile` | 对10米内最近敌人发射1枚导弹。基础伤害：20+10lv。爆炸范围：3米。冷却：6秒 | 3 | 配件 |
| 红 | 红外对抗 | `ir_counter` | 5米范围内正在瞄准玩家的最近的远程敌人穿甲率固定为0% | 1 | 配件 |

### 配件专属强化（扩展）示例

以下为部分新配件的专属强化示例，与地雷·范围/冷却/AT 同逻辑：拥有对应配件后，其专属强化才加入局内升级池。

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 白 | 烟雾弹·范围 | `smoke_range` | 烟雾弹影响范围 +2lv 米 | 5 | 强化（专属） |
| 白 | 烟雾弹·持续 | `smoke_duration` | 烟雾弹持续时间 +1lv 秒 | 5 | 强化（专属） |
| 白 | 无线电·半径 | `radio_radius` | 炮击影响半径 +1lv 米 | 5 | 强化（专属） |
| 蓝 | 外挂导弹·伤害 | `missile_damage` | 外挂导弹基础伤害 +25lv% | 5 | 强化（专属） |


### 系统说明
- **耐久**：即health，影响玩家的最大生命值
- **全局暴击率**：影响所有武器和配件的暴击率
- **伤害加成**：作用在计算护甲之前，在 `_compute_bullet_damage()` 中先乘以伤害加成
- **伤害强化影响范围**：伤害强化（`damage_bonus`）影响所有武器和配件的伤害，未经特殊说明的伤害加成类强化默认影响所有伤害来源
- **伤害类型**：
  - 伤害类型采用二元标签系统：伤害来源 + 是否暴击
  - **伤害来源**：`weapon`（武器）、`accessory`（配件）、`bleed`（流血）
  - **是否暴击**：布尔值，暴击时伤害数字显示为黄色，非暴击时根据伤害来源显示颜色
  - 武器伤害：白色（非暴击）或黄色（暴击）
  - 配件伤害：白色（非暴击）或黄色（暴击）
  - 流血伤害：绯红色（不暴击）

---

## 主武器强化（通用）

### 射速类强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 白 | 速射 | `rapid_fire` | 射速 +5lv% | -1 | 强化 |
| 蓝 | 连射 | `chain_fire` | 射速 -5lv%。主武器射击时，+3%射速，最多叠加4lv层，每1秒减少1层 | 5 | 强化 |
| 蓝 | 散弹 | `scatter_shot` | 主武器每射击10/8/7/6/5次（随等级递减），向随机方向进行1/1/2/2/3次额外射击 | 5 | 强化 |
| 紫 | 爆射 | `burst_fire` | 主武器暴击时，+4%射速，最多叠加4lv层，每1秒减少1层 | 10 | 强化 |
| 蓝 | 扫射 | `sweep_fire` | 主武器射击方向变更-扫射*：主武器射击方向旋转并追踪最近敌人\n射速 +50lv% | 2 | 强化 |
| 蓝 | 乱射 | `chaos_fire` | 主武器射击方向变更-乱射*：主武器射击方向随机（每次射击完全随机方向）\n射速 +100% | 1 | 强化 |
| 紫 | 破竹 | `breakthrough` | 场上存在的怪物数量越少，获得越多射速加成，最多+25lv%（怪物数量N，则+25lv%/N射速） | 3 | 强化 |
| 红 | 火力压制 | `fire_suppression` | 自身配件数量越多，获得越多射速加成（配件数量N，则+5lv*N%射速） | 2 | 强化 |

### 穿透/弹道类强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 穿透 | `penetration` | 伤害 -10lv%，主武器穿透+1lv | 5 | 强化 |
| 蓝 | 风车 | `windmill` | 主武器射击方向变更-风车*：主武器射击方向随时间顺时针旋转，各弹道均匀分布\n射速 -50%\n伤害 -20%\n主武器弹道+2 | 1 | 强化 |
| 蓝 | 风车·弹道 | `windmill_spread` | （风车衍生强化）\n伤害 -10lv%\n主武器弹道+1/2/3 | 3 | 强化（专属） |
| 蓝 | 风车·转速 | `windmill_speed` | （风车衍生强化）\n射速 +10lv%\n风车旋转速度 +30lv% | 3 | 强化（专属） |
| 紫 | 弹射 | `ricochet` | 主武器子弹命中后，有(10+10lv)%概率向最近敌人弹射。弹射在穿透前判定，成功则不消耗穿透次数 | 4 | 强化 |
| 红 | 扩散 | `spread_shot` | 主武器弹道+1/2/3，每发子弹造成50%/40%/30%伤害 | 3 | 强化 |
| 红 | 分裂 | `split_shot` | 主武器暴击时，子弹分裂成2/3发（随等级），每发造成50%伤害。仅在弹射失败时触发，不消耗穿透次数。分裂子弹无法再分裂 | 2 | 强化 |

### 穿透/穿甲扩展

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 长倍径炮管 | `long_barrel` | 主武器穿透 +1lv，伤害 -5lv%，射速 +10lv% | 5 | 强化 |
| 紫 | 串联破甲 | `tandem_heat` | 主武器穿透 +1lv，对护甲目标的穿甲伤害倍率 +20lv% | 5 | 强化 |

### 暴击类强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 紫 | 屏息 | `breath_hold` | 主武器未进行射击时，以+10lv%/秒的速率给予暴击伤害加成。主武器射击后清空所有加成 | 10 | 强化 |
| 紫 | 专注 | `focus` | 主武器连续命中同一敌人时，每发+1lv%暴击率，最多叠加5层。未命中该敌人时重新计算 | 5 | 强化 |
| 紫 | 收割 | `harvest` | 暴击击杀敌人时，恢复1lv点耐久 | 5 | 强化 |
| 红 | 致命一击 | `lethal_strike` | 主武器每射击9/7/5/3次，下一次射击暴击率+100%，且暴击伤害翻倍 | 4 | 强化 |
| 红 | 暴击转换 | `crit_conversion` | 暴击时，暴击率加成会作用于暴击伤害加成 | 1 | 强化 |

### 流血与持续伤害

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 白 | 锐化 | `sharpened` | 暴击时附加的流血层数 +1lv | 3 | 强化 |
| 蓝 | 放血 | `bloodletting` | 每层流血每米造成的伤害 +0.2lv（在基础 1 点上叠加） | 5 | 强化 |
| 紫 | 撕裂 | `laceration` | 流血层数上限 +2lv，暴击时若目标已有流血则额外 +1 层 | 5 | 强化 |

### 弹道与弹速（可选实现）

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 白 | 高装药 | `hot_load` | 主武器弹速 +10lv% | 5 | 强化 |
| 蓝 | 稳定翼 | `fin_stabilized` | 主武器弹道扩散角 -20lv%（最小为 0） | 5 | 强化 |

---

## 机炮专属强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 机炮·过载 | `mg_overload` | 射速 +50%，主武器射击时，-5/4/3%射速（随等级），最多叠加12/15/20层，每1秒减少1/2/3层 | 3 | 强化（专属） |
| 紫 | 机炮·重弹 | `mg_heavy_round` | 射速 -10lv%，主武器基础伤害+1lv | 5 | 强化（专属） |
| 红 | 机炮·高爆弹 | `mg_he_round` | 主武器基础伤害+3，穿透固定为1 | 1 | 强化（专属） |
| 紫 | 机炮·编程弹 | `mg_programmed` | 对无护甲/轻甲伤害 +20lv%，射速 +10lv%。仅机炮 | 5 | 强化（专属） |

---

## 榴弹炮专属强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 榴弹炮·装填 | `howitzer_reload` | 榴弹炮射速 +10lv% | 5 | 强化（专属） |
| 紫 | 榴弹炮·爆炸半径 | `howitzer_radius` | 榴弹炮爆炸范围 +0.5lv 米 | 5 | 强化（专属） |

---

## 坦克炮专属强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 紫 | 坦克炮·穿深 | `tank_gun_depth` | 坦克炮硬攻深度 +2lv mm | 5 | 强化（专属） |
| 蓝 | 坦克炮·穿透 | `tank_gun_penetration` | 坦克炮穿透 +1lv | 5 | 强化（专属） |

---

## 导弹主武器专属强化

| 品质 | 名称 | ID | 效果 | 最大等級 | 类型 |
| --- | --- | --- | --- | --- | --- |
| 蓝 | 导弹·齐射 | `missile_salvo` | 每次发射额外 +1lv 枚导弹 | 5 | 强化（专属） |
| 蓝 | 导弹·装填 | `missile_reload` | 导弹射速 +10lv% | 5 | 强化（专属） |

---

## 机炮基础数据

### 基础属性

- **基础伤害**：4
- **初始弹道数**：1（每次射击发出 `spread_count` 发）
- **射速（基础）**：300 发/分钟
- **弹速**：900
- **穿透次数**：0
- **弹道扩散**：每枚子弹约 ±3° 角度
- **溅射**：0（默认不产生额外连锁伤害）
- **流血层数**：0（暴击后附加的流血层）
- **每层流血伤害**：1 （每移动 1 米造成 1 点伤害并减少一层）

---

## 系统说明与实现要点

### 0. 击穿机制（含义、判定与实现）

#### 含义与现实意义

- **击穿**：当攻击方的**穿深**（硬攻深度，如 mm）**大于**受击方的**装甲厚度**时，视为弹头穿透装甲、进入车体。
- 穿透装甲的那部分伤害（硬攻 × 覆甲率）会转化为破片、引燃等二次杀伤，即**击穿伤害**。泄压阀、纤维内衬、车身附加装甲等，用来减轻**我方作为受击方**时，敌人「击穿进来」的这部分伤害。
- **未击穿**：穿深 ≤ 装甲厚度时，穿甲部分被装甲完全挡住，只对未装甲覆盖部分造成伤害，不产生击穿伤害。

#### 判定与公式（与策划书、FomulaManager 一致）

**输入**：基础伤害、硬攻倍率、软攻倍率、**穿深**、敌方装甲厚度、敌方覆甲率、敌方击穿伤害减免。

- **击穿**（穿深 > 敌方装甲）：
  - 伤害 = 硬攻 + 软攻×(1 − 覆甲率)
  - 击穿伤害 = 硬攻 × 覆甲率
  - 最终伤害 = 伤害 − 击穿伤害 × 击穿伤害减免
- **未击穿**（穿深 ≤ 敌方装甲）：
  - 最终伤害 = (硬攻 + 软攻) × (1 − 覆甲率)，无击穿伤害。

实现见 `FomulaManager.calculate_damage()`：`hard_attack_depth_mm > enemy_armor_thickness` 为击穿分支；`hard_attack * enemy_armor_coverage` 为击穿伤害，乘以 `enemy_hard_attack_damage_reduction` 后从总伤害中扣除。

#### 与升级的对应

- **泄压阀、车身附加装甲**：提高**玩家**的击穿伤害减免。仅当**敌人对玩家**造成伤害且判定为击穿时，对击穿伤害部分应用该减免。
- **纤维内衬**：抵御一次**致命击穿伤害**（击穿导致的致命伤），触发后失效。
- **红外对抗「穿甲率固定为 0%」**：将**正在瞄准玩家的该远程敌人**对玩家的击穿能力视为 0（等效穿深 ≤ 玩家装甲），即对方对玩家**永远未击穿**，只造成 (硬攻+软攻)×(1−覆甲率)，无击穿伤害。

---

### 1. 伤害加成计算位置
- **伤害+5%类词条**：作用在计算护甲之前
- 在 `_compute_bullet_damage()` 中先乘以伤害加成，然后再进行护甲计算

### 2. 定向词条机制
- 描述中带 `*` 的词条为【定向词条】，格式为 `前缀-名称*`
- 数据中使用英文 `prefix` 字段标识定向前缀（如 `"fire_direction"`），非定向词条 `prefix` 为空
- 选择后，从升级池中移除所有拥有相同 `prefix` 的其他定向词条
- 当前定向前缀：
  - `fire_direction`（主武器射击方向变更）：扫射、乱射、风车三选一
- 未来可扩展其他定向前缀

### 2.1 射击方向变更详情
- **扫射（追踪旋转）**：每 0.16 秒检测最近敌人，射击方向朝其旋转。角速度 = 60°/s + 450° × |夹角(rad)| /s，夹角越大旋转越快，趋近后减速。多弹道时按正常散射角分布。
- **风车（匀速旋转）**：基础 90 度/秒，可通过风车·转速衍生强化提升旋转速度。多弹道时各弹道均匀分布在 360°。
- **乱射（随机方向）**：每次射击时完全随机方向。多弹道时每发子弹独立随机方向。

### 3. 屏息机制
- **计时方式**：维护一个计时器，从上次射击开始计时
- **加成计算**：加成 = 未射击时间（秒）× 10lv% / 秒
  - 例如：0.5秒未射击 = 5lv%加成，1秒 = 10lv%，2秒 = 20lv%
- **重置**：每次射击时重置计时器为0，清空所有加成

### 4. 弹射机制
- **判定时机**：在穿透判定前进行
- **判定条件**：若附近没有敌人（攻击范围内没有敌人，子弹攻击范围半径继承自发射者），则直接判定不弹射
- **成功效果**：若判定成功，进行弹射且不消耗穿透次数

### 5. 分裂机制
- **触发时机**：在弹射判定失败后立刻触发（若无弹射强化，则命中后立刻触发）
- **不消耗穿透**：分裂不消耗穿透次数
- **复制方式**：分裂的子弹复制自原子弹（复制当前状态，特别是 `_hit_hurtboxes` 数组，避免立即命中同一目标）
- **伤害修改**：分裂的子弹伤害按照强化描述修改（50%伤害）
- **分裂标签**：分裂的子弹拥有分裂标签，无法再触发分裂

### 6. 属性系统变更
- **不再区分**：大部分全局属性和主武器属性（例如射速、暴击率等）
- **仍有区别**：
  - 主武器基础伤害 vs 配件基础伤害
  - 主武器穿透 vs 配件穿透
- **未来扩展**：以后有的配件可能不会吃到满射速加成

### 7. 专属强化与衍生强化
- **前缀标识**：类似"机炮·"、"地雷·"、"风车·"前缀的强化为专属/衍生强化
- **出现条件**：只有在玩家拥有相应前置升级（主武器、配件或强化）时才会在强化池中出现
- **统一机制**：数据中使用 `exclusive_for` 字段标识前置升级 id，选择任何升级后自动将以该 id 为 `exclusive_for` 的衍生强化加入局内升级池
- **示例**：
  - 选择地雷（`mine`）→ 加入 `mine_range`、`mine_cooldown`、`mine_anti_tank`
  - 装备机炮（`mg`）→ 加入 `mg_overload`、`mg_heavy_round`、`mg_he_round`
  - 装备榴弹炮（`howitzer`）→ 加入 `howitzer_reload`、`howitzer_radius`
  - 装备坦克炮（`tank_gun`）→ 加入 `tank_gun_depth`、`tank_gun_penetration`
  - 装备导弹主武器（`missile`）→ 加入 `missile_salvo`、`missile_reload`
  - 选择风车（`windmill`）→ 加入 `windmill_spread`、`windmill_speed`

### 8. 敌人数量获取
- 使用 `get_tree().get_nodes_in_group("enemy")` 获取场上所有敌人
- 参考 `machine_gun_ability_controller.gd` 中的实现

### 9. 配件数量获取
- 通过 `GameManager.get_vehicle_config()` 获取车辆配置
- 通过 `vehicle_config.get("配件")` 获取配件数组
- 配件数量 = 配件数组的长度

### 10. 流血处理
- 暴击后会在目标身上添加 `BleedEffect` 节点
- 每移动 1 米造成 `bleed_damage_per_layer` 点伤害，并减少一层
- 层数为 `bleed_layers`

### 11. 配件系统
- **配件类型**：配件分为两类
  - **强化型配件**：如「冷却装置」，效果类似强化，无独立实体（冷却速度 +15lv%，仅冷却类配件）
  - **副武器型配件**：如地雷、烟雾弹、无线电、激光压制等，有独立实体或技能行为
- **装填速度 vs 冷却速度**：见篇首声明。地雷、烟雾弹等使用**装填速度**；无线电、激光压制等使用**冷却速度**。冷却装置只提升**冷却速度**（不影响装填速度）。
- **配件获得**：局内升级时选择配件，若未拥有则获得（等级1），若已拥有则升级（等级+1）
- **配件伤害**：默认走护甲计算，伤害类型为 `"accessory"`，暴击相关与主武器类似（全局暴击率、暴击伤害等）
- **配件专属强化**：只有拥有对应配件时，其专属强化才会出现在升级池中

### 12. 地雷配件机制
- **基础属性**：
  - 基础装填间隔：3 秒（装填速度倍率 1，即 100%）
  - 基础爆炸范围：3 米
  - 基础伤害：5×等级
  - 部署上限：10+5×等级
- **部署机制**：
  - 装填间隔 = 基础装填间隔 / 装填速度倍率（倍率 = 1 + 装填速度加成）；若倍率 ≤ 0 则间隔为无穷（不装填）。
  - 地雷为 `Area2D` 节点，敌人进入范围时触发爆炸；到达部署上限时，自动触发最早部署的地雷爆炸，然后放置新地雷。
- **专属强化效果**：
  - `mine_range`：爆炸范围 +1.5×等级 米
  - `mine_cooldown`：装填速度 +15×等级%（倍率加成）
  - `mine_multi_deploy`：基础伤害 -1×等级；每次部署地雷数量 +1×等级
  - `mine_anti_tank`：基础装填间隔 +5 秒（再参与倍率除法），基础伤害 +200×等级%，仅精英/BOSS可触发
- 冷却装置不作用于地雷（地雷使用装填速度）

### 13. 升级池动态管理
- **升级池数据库**：存储所有可用的升级条目（包括专属强化），在游戏启动时初始化，可在任何场景访问
- **局内升级池**：当前对局中实际可抽取的升级池，在进入任务时根据当前装备状态初始化
- **动态调整机制**：
  - 玩家选择配件后，将该配件的专属强化加入局内升级池
  - 玩家装备主武器后，将该主武器的专属强化加入局内升级池
  - 升级达到满级后，从局内升级池中移除
  - 互斥升级选择后，从局内升级池中移除互斥选项
- **抽取逻辑**：`pick_upgrades()` 只从局内升级池中抽取，不再进行过滤
- **支持任务前选择**：数据库初始化在autoload中，支持在任务前的武器/配件选择界面查看和选择

---

## 与数据整理的对应及实现注意

本节说明《数据整理》中旧配件/属性在本升级合集内的映射与实现要点，便于实现时对齐数值与语义。

### 属性映射（数据整理 → 当前系统）| 数据整理字段 | 当前系统对应 | 说明 |
| --- | --- | --- |
| 生命值 / 生命回复 | 耐久 `health`；散热器 `heat_sink`（耐久换冷却）、维护工具箱 `repair_kit`（每冷却秒回 1）、车载空调 `cabin_ac`（回耐久时减冷却） | 射速/装填/冷却见篇首声明，三者运作方式相同 |
| 动力/马力 | 移速（克里斯蒂悬挂、燃气轮机）；液气悬挂=移速惩罚减半 | 移速需在玩家/载具上参与移动计算 |
| 装甲厚度/击穿伤害减免 | 被击穿伤害减免（车身附加装甲、泄压阀） | 见 **0. 击穿机制**；仅击穿时对击穿伤害部分应用减免 |
| 软攻倍率/穿甲倍率 | 对轻甲加成（半穿甲弹）、穿甲倍率（串联破甲） | 软攻→对无/轻甲；穿甲→护甲目标穿甲倍率，与 FomulaManager 对接 |
| 射速/暴击率/爆伤 | 射速、暴击率、暴击伤害；额外弹药架同时影响装填与射速 | 长倍径、编程弹等做组合或专属 |
| 地形惩罚衰减率 | 液气悬挂：受到的移速惩罚减半 | 单级，不随等级 |

### 配件/强化对应表（数据整理 ID → 升级合集）

| 数据整理 | 升级合集中 ID / 名称 | 备注 |
| --- | --- | --- |
| 遥控武器站(0) | 已有「伤害强化」；可叠「先进热成像仪」`thermal_imager` | 热成像：暴击率 +5%，1 级 |
| 破障设备(1) | `breach_equip` 破障设备 | 撞击伤害 = 当前移速×耐久×0.5lv，配件 |
| 改进自动装弹机(2) | 已有「速射」等射速强化 | — |
| 克里斯蒂悬挂(3) | `christie_suspension` 克里斯蒂悬挂 | 移速 +10lv% |
| 外挂履带板(4) | 已有「耐久强化」；可叠「车载空调」`cabin_ac` | — |
| APFSDS(5) | 穿透/穿甲向：`penetration`、`tandem_heat`、机炮·高爆弹 | — |
| 烟雾弹(6) | `smoke_grenade` 烟雾弹 | 配件、基础装填间隔 10 秒、1 米范围移速 -20lv%、持续 3 秒 |
| 无线电(7) | `radio_support` 无线电通讯 | 配件、基础冷却间隔 60-5lv 秒、范围炮击不分敌我 |
| 先进热成像仪(8) | `thermal_imager` 先进热成像仪 | 暴击率 +5%，1 级 |
| 散热器(9) | `heat_sink` 散热器 | 耐久 -5lv，冷却随耐久上限降低而加快 |
| 车载空调(10) | `cabin_ac` 车载空调 | 回复耐久时 -5lv% 冷却，持续 3 秒，不可叠加 |
| 额外弹药架(11) | `extra_ammo_rack` 额外弹药架 | 耐久 -5lv，移速 -10%，装填速度 +10lv%，射速 +10lv% |
| 长倍径炮管(12) | `long_barrel` 长倍径炮管 | 穿透 +1lv，伤害 -5lv%，射速 +10lv% |
| 激光测距仪(13) | `laser_rangefinder` 激光测距仪 | 暴击率 +4%，1 级 |
| 半穿甲弹(14) | `sap_round` 半穿甲弹 | 对无/轻甲 +10lv%，暴伤 +30lv% |
| 串联破甲(15) | `tandem_heat` 串联破甲 | 穿透 +1lv，穿甲倍率 +20lv% |
| 编程弹(16) | `mg_programmed` 机炮·编程弹 | 仅机炮，对无/轻甲 +20lv%，射速 +10lv% |
| 车身附加装甲(17) | `addon_armor` 车身附加装甲 | 耐久 +4lv，被击穿伤害减免 5lv% |
| 燃气轮机(18) | `gas_turbine` 燃气轮机 | 移速 +15lv% |
| 液气悬挂(19) | `hydro_pneumatic` 液气悬挂 | 受到的移速惩罚减半，1 级 |
| 维护工具箱(20) | `repair_kit` 维护工具箱 | 每{冷却}秒回复 1 耐久，冷却随等级 15→4 秒 |
| 激光压制(21) | `laser_suppress` 激光压制 | 配件、冷却 30 秒、5 秒内对瞄准玩家的最近远程敌人持续伤害 |
| 纤维内衬(23) | `spall_liner` 纤维内衬 | 配件、被动、抵御一次致命击穿 |
| 爆炸反应装甲(24) | `era_block` 爆炸反应装甲 | 配件、被动、抵御一次任意致命，与内衬共存、优先触发 |
| 外挂导弹(25) | `external_missile` 外挂导弹 | 配件、10 米内最近敌人、基础伤害 20+10lv、爆炸 3 米 |
| 红外对抗(26) | `ir_counter` 红外对抗 | 配件、5 米内瞄准玩家的最近远程敌人穿甲率固定为 0% |
| 泄压阀(27) | `relief_valve` 泄压阀 | 被击穿伤害减免 10lv%（强化，非配件） |
| 全穿甲弹链(28) | 已有机炮·高爆弹等 | 机炮专属穿甲向已有体现 |
| 被帽风帽穿甲弹(29) | 预留榴弹专属 | 若今后有榴弹武器，可单独做「榴弹·被帽」等 |

### 实现注意

1. **移速**：克里斯蒂悬挂、燃气轮机、液气悬挂若接入，需在玩家或载具上提供移速倍率或基础移速+百分比的接口，并在移动逻辑中统一乘算。
2. **击穿与减免**：见 **0. 击穿机制**。泄压阀、车身附加装甲提高玩家击穿伤害减免，仅当敌人对玩家造成伤害且判定为击穿时，对击穿伤害部分应用减免。
3. **对轻甲/无甲加成**：半穿甲弹、机炮·编程弹依赖敌人护甲厚度或“是否轻甲”标记，需在 FomulaManager 或伤害链路中接入对软目标倍率。
4. **装填与冷却**：地雷、烟雾弹等用装填；无线电、激光压制、外挂导弹等用冷却。冷却装置只减冷却，不减装填。纤维内衬、爆炸反应装甲为一次性被动，触发后局内标记已消耗。
5. **互斥与池子**：新强化与现有扫射/乱射等互斥逻辑无冲突；新配件的专属强化（若有）需在选定该配件后加入局内升级池，与地雷、机炮的现行规则一致。
