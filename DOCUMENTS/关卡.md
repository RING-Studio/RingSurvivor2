# 关卡与怪物设计文档

更新日期：2026-02-14

---

## 一、怪物设计

### 背景设定
本作背景为沙漠末世，军营是一座沙漠绿洲小城。
敌人主要分为两类：
- **污染生物**：被环境污染变异的沙漠生物（甲虫、蝎子、蜱虫、蜥蜴、真菌体等）
- **机械残骸**：被污染侵蚀后失控的废弃军用车辆/装备

### 1. 小怪一览

| ID | 显示名称 | class_name | 类型 | 基础HP | 移速 | 装甲 | 覆甲率 | 基础伤害 | 特性简述 |
|----|----------|------------|------|--------|------|------|--------|----------|----------|
| sand_scarab | 沙漠圣甲虫 | SandScarab | 近战 | 20 | 75/20加速 | 1.0 | 10% | 1 | 基础近战敌人，直线追踪玩家 |
| spore_caster | 孢子投手 | SporeCaster | 远程 | 15 | 50/15加速 | 1.0 | 10% | 1 | 中距离停下射击孢子弹；`is_aiming_player`；`ranged_enemy` 组 |
| charger_enemy | 沙丘甲虫 | DuneBeetle | 近战 | 12 | 50→200冲刺 | 2.0 | 20% | 3 | 慢速追踪→蓄力→高速冲刺→眩晕循环 |
| bomber_enemy | 膨爆蜱 | BloatTick | 近战/AoE | 8 | 80/30加速 | 0 | 0% | 5(爆炸) | 接近自爆；被击杀也会爆炸（伤害减半） |
| tank_enemy | 锈壳重甲 | RustHulk | 近战 | 40 | 35/10加速 | 12.0 | 80% | 2 | 废弃装甲车残骸；高装甲+免疫击退 |
| spitter_enemy | 酸液射手 | AcidSpitter | 远程 | 18 | 55/15加速 | 3.0 | 30% | 2(弹丸) | 保持距离发射酸液弹丸；`ranged_enemy` 组 |

> **弃用**: `basic_enemy` (BasicEnemy)、`wizard_enemy` (WizardEnemy)、`bat_enemy` (BatEnemy) 均为外部模板场景，仅作参考，不再用于正式关卡。

### 2. 详细设计

#### 沙漠圣甲虫 (SandScarab)
- **描述**：常见的沙漠污染生物，外壳坚硬，以群体围攻为主要手段
- **行为**：直线追踪玩家，简单近战
- **文件路径**：`scenes/game_object/sand_scarab/`
- **占位视觉**：沙黄色 (0.85, 0.75, 0.45) self_modulate

#### 孢子投手 (SporeCaster)
- **描述**：沙漠中被污染的真菌体，会在中距离停下释放腐蚀性孢子弹
- **行为状态**：
  - 距玩家 > 180px：向玩家接近
  - 距玩家 120~180px：停下射击，每 2.5s 发射孢子弹
  - 具有 `is_aiming_player` 属性（用于激光压制/红外对抗）
  - 具有 `disable_aiming(duration)` 方法
- **弹丸**：速度 120px/s，存活 3.5s，紫色占位
- **文件路径**：`scenes/game_object/spore_caster/`
- **占位视觉**：紫色 (0.5, 0.3, 0.6) self_modulate

#### 沙丘甲虫 (DuneBeetle)
- **描述**：污染变异的大型沙漠甲虫，受到刺激后会高速冲锋
- **行为状态机**：
  1. `追踪`：以低速(50)向玩家移动
  2. `蓄力`：当距玩家 200px 以内时，停顿 0.5s，播放蓄力提示（变红闪烁）
  3. `冲刺`：朝蓄力时锁定的方向高速(200)直线冲刺，持续 0.8s
  4. `眩晕`：冲刺结束后原地停顿 1.0s，然后回到追踪状态
- **伤害**：冲刺中接触伤害 = base_damage × 2 = 6
- **文件路径**：`scenes/game_object/charger_enemy/`
- **占位视觉**：橘色 (0.9, 0.5, 0.2) self_modulate

#### 膨爆蜱 (BloatTick)
- **描述**：被污染胀大的沙漠蜱虫，体内充满腐蚀性液体
- **行为**：始终向玩家移动，接近 30px 以内时触发自爆
- **自爆**：半径 60px，伤害 5，延迟 0.3s（闪烁警告后爆炸）
- **被击杀爆炸**：伤害减半（2.5），半径不变
- **文件路径**：`scenes/game_object/bomber_enemy/`
- **占位视觉**：红色 (自带爆炸效果)

#### 锈壳重甲 (RustHulk)
- **描述**：被废弃后受污染侵蚀的装甲车残骸，缓慢但极其坚固
- **行为**：缓慢追踪玩家，无特殊状态
- **特殊属性**：
  - 免疫击退（`knockback_resist = true`）
  - 极高覆甲率(80%) + 厚装甲(12mm)
- **设计目的**：测试穿甲类升级（如 `armor_breaker`、`tank_gun_depth`）的实际效果
- **文件路径**：`scenes/game_object/tank_enemy/`
- **占位视觉**：蓝灰色 + 放大1.3倍

#### 酸液射手 (AcidSpitter)
- **描述**：沙漠中的变异蜥蜴，能从口腔喷射腐蚀性酸液
- **行为状态机**：
  1. `接近`：当距玩家 > 250px 时向玩家移动
  2. `攻击`：距玩家 100~250px 时停下，每 2.0s 发射一发酸液弹
  3. `后退`：距玩家 < 100px 时远离玩家
- **弹丸**：速度 150px/s，伤害 2，存活 3s
- **文件路径**：`scenes/game_object/spitter_enemy/`
- **占位视觉**：绿色 self_modulate

### 3. 精英/Boss 等级系统

#### EnemyRank 枚举
所有敌人脚本统一使用 `EnemyRank` 枚举替代旧的 `is_elite`/`is_boss` 布尔值：
```gdscript
enum EnemyRank { NORMAL = 0, ELITE = 1, BOSS = 2 }
@export var enemy_rank: int = EnemyRank.NORMAL
```

- `NORMAL (0)`：普通敌人
- `ELITE (1)`：精英敌人 — 12% 概率生成，scale 1.5，HP×3，药瓶必掉
- `BOSS (2)`：Boss 敌人 — 由关卡脚本直接生成

判定方式：直接读取 `enemy.enemy_rank`，不再使用 scale 判定。

#### 精英增幅规则
- 体型：scale 1.5（视觉区分）
- HP × 3
- 药瓶掉落：100%（`drop_percent = 1.0`）
- 后续可追加：伤害 × 1.5、移速 × 1.2、特效光环

### 4. Boss

| ID | class_name | 名称 | 基础HP | 装甲 | 覆甲率 | 移速 | 体型 | 特殊能力 |
|----|------------|------|--------|------|--------|------|------|----------|
| boss_titan | BossTitan | 污染巨兽 | 500 | 8.0 | 60% | 30 | scale 3.0 | 地面冲击波 AoE，每5s释放，半径120px，伤害15 |
| boss_hive | BossHive | 孵化母体 | 350 | 4.0 | 40% | 40 | scale 2.5 | 每8s召唤3~5只圣甲虫，受50+伤害立即召唤，上限15只 |

#### 污染巨兽 (BossTitan)
- **描述**：沙漠深处的巨型污染体，体型庞大，免疫击退
- **行为**：缓慢追踪玩家（速度 30）
- **冲击波**：每 5s 释放，以自身为中心 120px 半径范围 15 点伤害
- **视觉**：深红色 (0.55, 0.2, 0.15)，scale 3.0
- **enemy_rank**：默认 BOSS(2)
- **文件路径**：`scenes/game_object/boss_titan/`

#### 孵化母体 (BossHive)
- **描述**：深层污染区的巢穴核心，能持续孵化沙漠圣甲虫增援
- **行为**：保持与玩家 200px 距离，太近后退，不主动接近
- **召唤**：每 8s 召唤 3~5 只 SandScarab，受单次 50+ 伤害立即追加召唤
- **召唤上限**：同时存在不超过 15 只
- **视觉**：暗紫色 (0.4, 0.25, 0.5)，scale 2.5
- **enemy_rank**：默认 BOSS(2)
- **文件路径**：`scenes/game_object/boss_hive/`

---

## 二、LevelTest（原 Level1）

### 说明
原 Level1 本质为功能测试关卡，已重命名为 `LevelTest`，保留区域/生成逻辑供开发测试。

### 路径
- 场景：`scenes/Levels/LevelTest/LevelTest.tscn`
- 脚本：`scenes/Levels/LevelTest/LevelTest.gd`
- 敌人管理器：`scenes/Levels/LevelTest/level_test_enemy_manager.gd`

### 生成表

| 怪物 | class_name | 权重 |
|------|------------|------|
| 沙漠圣甲虫 | SandScarab | 4 |
| 孢子投手 | SporeCaster | 2 |
| 沙丘甲虫 | DuneBeetle | 2 |
| 膨爆蜱 | BloatTick | 1 |
| 锈壳重甲 | RustHulk | 1 |
| 酸液射手 | AcidSpitter | 1 |

---

## 三、关卡池设计

### 关卡结构说明
每个关卡由以下要素组成：
- `id`：唯一标识
- `name`：显示名称
- `description`：关卡描述
- `destination_id`：所属目的地（MissionMap 图标分组）
- `scene_path`：关卡场景路径（默认 LevelTest）
- `time_cost`：消耗时间段数
- `allow_phases`：允许出击的时间段
- `difficulty`：难度星级（1~5）
- `objectives`：**目标数组**（支持主/次目标、触发链、奖励）
- `reward_preview`：奖励预览文本
- `pollution_rules`：污染值变化规则
- `unlock_condition`：解锁条件

### MissionData 目标格式（仅供显示）

MissionData 中的 `objectives` 数组**只存显示信息**，不含逻辑参数：
```gdscript
{
    "id": "investigate_sources",    # 唯一标识
    "display_name": "调查污染源（前往区域中心）",  # HUD/MissionMap 显示名称
    "primary": true                 # 主目标(true) / 次要目标(false)
}
```

**关卡内的目标逻辑不由 MissionData 控制**，而是由关卡场景的 ObjectiveManager 子节点管理（见第六节）。

### 目标类型（由 ObjectiveManager 管理）

| 类型 | 说明 | ObjectiveManager 配置 |
|------|------|----------------------|
| 计时生存 | 存活指定时间 | `time_limit` |
| 歼灭 | 击杀指定数量 | `target` + 关卡 report_progress |
| Boss讨伐 | 击杀指定Boss | 关卡 report_complete |
| 据点防守 | 据点不被摧毁 | `time_limit` + 关卡 report_fail |
| 收集 | 收集掉落物品 | `target` + 关卡 report_progress |
| 到达区域 | 前往指定区域 | 关卡 report_complete |

### 触发链示例（虫巢清剿）

```
进入关卡 → 主目标1(调查污染源) + 次目标1(击杀膨爆蜱) + 次目标2(收集生物样本)
         ↓ 主目标1完成
         → 主目标2(击杀孵化母体) 出现 → Boss 生成 → 击杀 → 胜利
```

### 关卡列表

> 注：当前所有关卡的 `scene_path` 均暂时指向 LevelTest。

| # | ID | 名称 | 目的地 | 难度 | 主目标概要 | 次要目标 | 解锁条件 |
|---|-----|------|--------|------|-----------|----------|----------|
| 1 | recon_patrol | 野外侦察 | 外围巡逻区 | ★ | 存活 90s | — | 默认 |
| 2 | salvage_run | 残骸回收 | 废弃工厂 | ★ | 收集 20 核心 | 击杀 30 敌人 | 通关 #1 |
| 3 | containment | 污染封锁 | 污染带 | ★★ | 存活 120s | 击杀 5 精英 | 通关 #1 |
| 4 | extermination | 歼灭行动 | 污染带 | ★★ | 击杀 50/120s | — | 通关 #2 或 #3 |
| 5 | outpost_defense | 据点保卫 | 通信据点 | ★★★ | 防守 150s | 据点>50%HP | 通关 #4 |
| 6 | titan_hunt | 巨兽讨伐 | 巨兽巢穴 | ★★★ | 到达→击杀巨兽 | 90s内击杀 | 通关 #5 |
| 7 | hive_assault | 虫巢清剿 | 虫巢深处 | ★★★★ | 调查→击杀母体 | 杀30蜱+集10样本 | 通关 #6 |
| 8 | high_risk_sweep | 高危清剿 | 污染带 | ★★★★ | 击杀 80/150s | 击杀 10 精英 | 通关 #6 或 #7 |

---

## 四、关卡结算逻辑

### 胜利条件
**所有主目标（primary=true）完成** 即为胜利。
次要目标不影响胜败，但完成后记录在 `mission_progress.completed_objectives` 中，并给予额外奖励。

### 失败条件
- 玩家死亡 → 立即失败
- 任意主目标超时/条件未满足 → 立即失败
- 据点被摧毁（defend 主目标）→ 立即失败

### 结算流程
1. `ObjectiveManager` 判定所有主目标完成 → 发射 `all_primary_completed`
2. 关卡脚本调用 `GameManager.apply_mission_result("victory", completed_obj_ids)`
3. 根据 `pollution_rules` 计算新污染值
4. 推进时间段（`time_cost`）
5. 记录通关次数 + 已完成目标 ID → `mission_progress`
6. 自动存档
7. 显示结算画面 → 返回基地

---

## 五、MissionMap 场景设计

### 概述
`MissionMap` 是叠加在军营上的 CanvasLayer 覆盖层（不切换 current scene）。
包含一张地图，上面分布目的地图标；点击图标后右侧弹出该目的地的任务面板。

### 路径
- 脚本：`scenes/ui/mission_map.gd`
- 场景：`scenes/ui/mission_map.tscn`

### 目的地定义（DESTINATIONS）
在 `MissionData.gd` 的 `DESTINATIONS` 常量中定义：
```gdscript
{
    "id": "deep_hive",
    "name": "虫巢深处",
    "map_position": Vector2(0.85, 0.4),  # 归一化坐标
    "icon": "boss",
    "missions": ["hive_assault"]          # 关联的关卡 ID
}
```

### 当前目的地列表
| ID | 名称 | 关联关卡 |
|----|------|----------|
| patrol_zone | 外围巡逻区 | recon_patrol |
| scrapyard | 废弃工厂 | salvage_run |
| contamination_belt | 污染带 | containment, extermination, high_risk_sweep |
| comm_outpost | 通信据点 | outpost_defense |
| titan_lair | 巨兽巢穴 | titan_hunt |
| deep_hive | 虫巢深处 | hive_assault |

### 节点结构
```
MissionMap (CanvasLayer, layer=50)
├── Background (ColorRect, 深色遮罩)
├── TopBar (HBoxContainer)
│   ├── DayLabel / PhaseLabel / PollutionLabel
│   └── CloseButton ("返回军营")
├── MapTitle ("— 作战地图 —")
├── MapContainer (Control) ← 目的地 Button 动态生成于此
└── DetailPanel (PanelContainer, 右侧浮动面板)
    └── VBox
        ├── Title (目的地名称)
        ├── MissionList (VBoxContainer, 任务按钮列表)
        ├── Info (RichTextLabel, 详情+目标列表)
        └── Buttons (确认出击 / 返回)
```

### 交互流程
1. 军营出击点交互 → 打开 MissionMap
2. 地图上显示目的地按钮（已解锁/未解锁/已通关 三态）
3. 点击目的地 → 右侧面板弹出该目的地的关卡列表
4. 选择关卡 → 显示详情（含完整目标列表：主目标/次要目标/触发条件/已完成标记）
5. 确认出击 → 进入关卡场景
6. 返回 → 收起详情面板；关闭 → 恢复军营

---

## 六、关卡内目标系统（ObjectiveManager + ObjectiveHUD）

### 架构说明
- **ObjectiveManager**：Node 类型，作为**关卡场景树子节点**，管理目标逻辑
- **ObjectiveHUD**：PanelContainer 类型，作为 CanvasLayer 下的子节点，从 ObjectiveManager 读取状态显示 HUD
- MissionData **不参与逻辑**，只存供显示的文本
- 目标的定义、触发、计数全部由关卡脚本在 `_setup_objectives()` 中通过 `ObjectiveManager.add_objective()` 配置

### 路径
- ObjectiveManager 脚本：`scenes/manager/objective_manager.gd`
- ObjectiveHUD 脚本：`scenes/ui/objective_hud.gd`

### 目标状态机
- `hidden`：有前置目标（`after`），尚未解锁，HUD 显示 "???"
- `active`：正在追踪，显示进度
- `completed`：已完成，显示绿色 ✓
- `failed`：已失败，显示红色 ✗

### ObjectiveManager 信号
- `all_primary_completed`：所有主目标完成 → 触发胜利
- `primary_failed`：任意主目标失败 → 触发失败
- `objective_state_changed(obj_id, new_state)`：任一目标状态变化

### ObjectiveManager 接口
- `add_objective(config: Dictionary)`：添加目标
  - config: `{id, display_name, primary, target, time_limit, after}`
- `report_progress(obj_id, amount)`：增加计数
- `report_complete(obj_id)`：直接标记完成
- `report_fail(obj_id)`：直接标记失败
- `is_active(obj_id) -> bool`
- `is_completed(obj_id) -> bool`
- `get_completed_secondary_ids() -> Array[String]`

### HUD 布局（右上角面板）
```
— 主要目标 —
○ 调查污染源（前往区域中心）
● 击杀孵化母体  ✓
— 次要目标 —
○ 击杀 30 只膨爆蜱  18/30
○ 收集 10 个生物样本  3/10
已用时 2:15
```

### 集成方式（场景树子节点）
```
LevelTest (Node)
├── ...其他节点...
├── ObjectiveManager (Node, script=objective_manager.gd)
├── ObjectiveHUDLayer (CanvasLayer, layer=10)
│   └── ObjectiveHUD (PanelContainer, script=objective_hud.gd)
│       └── MarginContainer → VBoxContainer
```

关卡脚本通过 `@export var objective_manager: ObjectiveManager` 引用，在 `_setup_objectives()` 中配置目标：
```gdscript
# LevelTest.gd
func _setup_objectives():
    match GameManager.current_mission_id:
        "titan_hunt":
            objective_manager.add_objective({"id": "reach_lair", "display_name": "前往巨兽巢穴", "primary": true})
            objective_manager.add_objective({"id": "kill_titan", "display_name": "击杀污染巨兽", "primary": true, "time_limit": 180, "after": "reach_lair"})

func notify_enemy_killed(enemy):
    # 关卡脚本负责根据敌人类型判断该推进哪个目标
    if is_boss and enemy_class == "BossTitan":
        objective_manager.report_complete("kill_titan")

func notify_area_reached(area_id):
    if area_id == "region3":
        objective_manager.report_complete("reach_lair")
```

---

## 七、实现要点（区域系统、LevelTest 专用）

### 区域划分 (LevelTest 沿用 Level1 结构)

#### Region1_x 系列
- **点污染度**: `1000 + 全局污染度`
- **随机生成上限**: `9 + 点污染度 / 1000`
- **属性倍率**: `1.0 + 点污染度 / 1000`

#### Region2_x 系列
- **点污染度**: `1000 + 全局污染度 + 与地图中心距离`
- **随机生成上限**: `10 + 点污染度 / 500`
- **属性倍率**: `1.1 + 点污染度 / 500`

#### Region3
- **点污染度**: `3000 + 全局污染度`
- **随机生成上限**: 固定 10
- **属性倍率**: `1.1 + 点污染度 / 500`
- **特殊**: 三体组生成（圣甲虫×2 + 孢子投手×1）+ Boss 生成（默认 BossTitan，可通过 `spawn_boss("boss_hive")` 切换）

### 怪物标签系统
- `enemy`：所有敌人（武器/配件目标检测）
- `ranged_enemy`：远程敌人（SporeCaster, AcidSpitter）
- `random_enemy`：随机生成的敌人，计入上限
- `fixed_enemy`：固定生成（Boss），不计入上限

### EnemyRank 判定
- 通过 `enemy.enemy_rank` 属性判定（0=普通, 1=精英, 2=Boss）
- 不再使用 scale 判定
- 地雷·AT 等精英/Boss 触发判定使用 `enemy_rank >= 1`
