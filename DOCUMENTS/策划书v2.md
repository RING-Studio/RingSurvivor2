# 《花园都市的沙心水源》游戏策划书 v2

更新日期：2026-02-14

本文件是当前口径的策划书 v2，用于覆盖或补充旧版本设计。

---

## 1. 游戏定位与核心循环

### 1.1 游戏类型
类幸存者 Roguelike + AVG（剧情对话）+ 基地经营

### 1.2 背景设定
沙漠末世，军营是一个沙漠绿洲小城。玩家驾驶改装车辆在污染区域执行任务。
敌人主要是：污染变异生物（甲虫、蜱虫、真菌体等）和废弃机械残骸。

### 1.3 核心循环
```
军营(配装/对话/商店) → MissionMap(选择任务) → 进入关卡(Roguelike战斗)
→ 关卡结算(胜利/失败) → 返回军营(升级清空、污染变化、进度记录)
```

### 1.4 Roguelike 规则
- **单局升级清空**：每次进入关卡时，上一局的所有升级（current_upgrades）全部清空
- 关卡中通过击杀获取经验 → 升级时从池中随机抽取配件/强化
- 带入配件：车辆配装中选择的配件会在局开始时预装（保留跨局）
- 关卡结束后只保留：污染能量（金币）、任务完成记录、通关状态

### 1.5 玩家体验核心
a. **任务推进**：通关解锁新关卡、推进剧情
b. **污染值维持**：通过出击降低污染，不出击则污染持续上升
c. **配装优化**：用污染能量购买/升级配件，更好的配装应对更难的任务

---

## 2. 污染值与时间推进

### 2.1 基础规则
- 时间段：早/午/晚（每天 3 段）
- 不进行任务度过一个时间段：`污染 += 300`

### 2.2 任务结果的污染变动（默认）
- **任务完成（胜利）**：`污染 = floor(污染 * 0.9) + 300`
- **任务失败**：`污染 += 300`
- **不出击**：`污染 += 300`

不同任务可拥有独特的污染变动公式，在 MissionData 的 `pollution_rules` 中覆盖默认逻辑。

---

## 3. 任务系统

### 3.1 MissionMap 界面
- 入口：军营出击点 → 打开 MissionMap（CanvasLayer 覆盖层，不切换 current scene）
- 地图上分布目的地图标（按区域分组）
- 点击目的地 → 右侧面板显示该区域可选任务列表
- 确认出击 → 进入对应关卡场景

### 3.2 目的地与关卡
- 目的地（DESTINATIONS）：地图上的可点击区域，每个关联若干任务
- 当前目的地：外围巡逻区、废弃工厂、污染带、通信据点、巨兽巢穴、虫巢深处

### 3.3 关卡配置（MissionData）
MissionData 是**纯数据表**，仅供 MissionMap 显示：
- id / name / description / difficulty / time_cost / allow_phases
- destination_id（所属目的地）
- reward_preview（奖励预览文本）
- pollution_rules（污染变化公式）
- unlock_condition（解锁条件）
- objectives（**仅显示用**：id + display_name + primary 布尔值）

**关卡内的目标逻辑不由 MissionData 控制**，而是由各关卡场景的 ObjectiveManager 节点管理。

### 3.4 关卡内目标系统
- **ObjectiveManager**：Node 类型，放入每个关卡场景树，负责目标状态、进度追踪、触发链、胜负判定
- **ObjectiveHUD**：PanelContainer，放入 CanvasLayer 子节点，从 ObjectiveManager 读取状态显示 HUD
- 目标类型：计时生存(survive)、歼灭(eliminate)、Boss讨伐(boss_kill)、据点防守(defend)、收集(collect)、到达区域(reach_area)
- 触发链：目标可设 `after` 前置，前置完成后解锁
- 胜利条件：所有主目标完成
- 失败条件：任意主目标失败 / 玩家死亡

### 3.5 关卡解锁链
通过 `unlock_condition` 配置：
- `clear_mission: "id"` — 需通关指定关卡
- `clear_any: ["id1", "id2"]` — 需通关其中任一
- 通关后自动检查并解锁满足条件的后续关卡

---

## 4. 敌人设计

### 4.1 设计原则
- 沙漠末世主题：污染生物（甲虫、蜱虫、蜥蜴、真菌体）+ 机械残骸
- 不使用弃用的外部模板（basic_enemy / wizard_enemy / bat_enemy）

### 4.2 敌人等级（EnemyRank）
```gdscript
enum EnemyRank { NORMAL = 0, ELITE = 1, BOSS = 2 }
@export var enemy_rank: int = EnemyRank.NORMAL
```
- 不使用 scale 判定，直接读 `enemy_rank` 属性
- 精英增幅：scale 1.5、HP×3、药瓶必掉
- Boss：由关卡脚本按目标条件生成

### 4.3 当前敌人（6 种小怪 + 2 种 Boss）
| 名称 | class_name | 类型 | 简述 |
|------|------------|------|------|
| 沙漠圣甲虫 | SandScarab | 近战 | 基础追踪 |
| 孢子投手 | SporeCaster | 远程 | 停下射击孢子弹 |
| 沙丘甲虫 | DuneBeetle | 冲锋 | 蓄力→冲刺→眩晕 |
| 膨爆蜱 | BloatTick | 自爆 | 接近自爆 AoE |
| 锈壳重甲 | RustHulk | 重装 | 高装甲+免疫击退 |
| 酸液射手 | AcidSpitter | 远程 | 保持距离射酸液 |
| 污染巨兽 | BossTitan | Boss | 冲击波 AoE |
| 孵化母体 | BossHive | Boss | 召唤圣甲虫增援 |

---

## 5. 升级与配件系统

### 5.1 Roguelike 升级池
- 关卡中击杀获取经验 → 升级时从池中随机抽取
- 品质：白/蓝/紫/红，同品质内等概率
- 配件获得后解锁其专属强化进入升级池
- 满级的升级从池中移除

### 5.2 车辆配装（跨局持久）
- 在军营的改装工坊（CarEditor）中进行
- 选择主武器、带入配件
- 带入配件在局开始时自动预装（不需要局内抽取）

### 5.3 升级生命周期
```
局开始 → current_upgrades 清空 → 带入配件预装 → 升级池初始化
→ 局中升级... → 局结束 → 升级返还能量计算 → current_upgrades 清空
```

### 5.4 升级的游戏背景设定（污染能量）
玩家阵营配备有**污染转换器**，可以将污染转换为能量（主要从污染怪物身上提取），即"**污染能量**"。
集齐一定能量，就能进行一次"升级"。但这种"升级"在污染转换器过载后（即任务时限结束）会失效，
返还一定数量能量并存入**能量池**（即局外能量/money）。

---

## 5A. 关卡结算与带出物品（待实现）

### 5A.1 结算时机
关卡结束（无论胜负）后，进行"带出物品"结算。

### 5A.2 带出规则
| 结果 | 带出比例 | 说明 |
|------|---------|------|
| 胜利 | 100% | 带出所有物品 |
| 失败 + 玩家死亡 | 10%~40% | 依照关卡规则，损失大部分物品 |
| 失败 + 玩家存活 | 70%~90% | 依照关卡规则，损失小部分物品 |

> 以上比例为默认参考。不同关卡可通过关卡脚本自定义损失规则。

### 5A.3 带出物品内容

**a. 怪物素材**
- 击杀敌人掉落的素材类收集物（bio_sample、energy_core 等）
- 按关卡内实际收集数量 × 带出比例 计算

**b. 升级返还能量**
- 所有局内获得的升级（包括带入配件）按"价值"以随机比例返还为污染能量
- 价值 = `品质基准 × 等级 / 等级上限 × 10`（待定）
- 品质基准参考：白=1, 蓝=3, 紫=8, 红=20
- 返还比例受关卡结果影响

### 5A.4 目标奖励
- 目标完成可触发多种奖励，**不局限于 money**
- 可能的奖励类型：
  - 污染能量（money）
  - 怪物素材
  - 新目标/新关卡解锁
  - 主线任务推进
  - 局外配件/武器解锁
  - 以上多种的组合
- 奖励由**关卡脚本全权管理**，不在 MissionData 中硬编码
- MissionMap 不显示目标奖励/关卡奖励，但显示"哪些目标已被完成过"（绿色 ✓）

---

## 5B. 配装系统（待实现）

### 5B.1 概述
配装系统是"军营配装 → 出击结算 → 局内战斗"的桥梁。
玩家在军营中进行**解锁 → 装备（预制造）→ 出击结算**三步流程。

### 5B.2 解锁
玩家需要满足特定条件后才能解锁配件/武器/装甲。

| 类别 | 默认解锁条件 | 说明 |
|------|-------------|------|
| 配件 | 在某局任务中选择过一次该升级 | 即局内抽到并选择后，局外永久可用 |
| 武器 | 怪物素材 + 任务推进 | 各武器具体需求待定 |
| 装甲 | 怪物素材 + 任务推进 | 各装甲具体需求待定 |

- 未达成条件：显示"未解锁"+ 解锁条件描述
- 达成条件后：显示"解锁"按钮，点击解锁（可能需要少量资源）

### 5B.3 装备（预制造）
解锁后的配件/武器/装甲可以进行"装备"操作。

- 装备需要花费资源：能量（money）、怪物素材等
- 这个"装备"实际上是**预装备 / 预制造**
- 资源不在装备时扣除，而是在**出击时结算**
- 出击时：
  - 检查玩家当前配装所需总资源
  - 资源充足 → 扣除资源，进入关卡，按配装初始化
  - 资源不足 → 提示"材料不足"，禁止出击（可进入 MissionMap 查看，但确认出击按钮不可用）

### 5B.4 配件升级（预升级）— 待设计
装备某一配件后，可以选择对其进行"升级"（预升级）。
此功能在 5B.3 实现后再详细设计。

---

## 6. 存档设计

### 6.1 原则
- **不考虑存档兼容**：随时可改结构，旧存档作废
- `current_mission_id` / `current_upgrades` 等运行时变量不存档

### 6.2 持久化字段
- `mission_progress`：关卡解锁/完成状态（clear_count、completed_objectives、best_score）
- `chapter_progress`：章节完成状态
- `npc_dialogues`：NPC 对话进度（待实现）
- `objectives`：主线/支线目标进度（待实现）
- `materials`：怪物素材库 `{ "material_id": amount, ... }`
- 车辆配置、金钱、污染值、时间等

---

## 7. MissionMap 界面布局

### 7.1 结构
- 顶部信息区：天数、时间段、全局污染值
- 中央地图区：目的地图标按钮（未解锁灰/可用白/已通关绿）
- 右侧详情面板：关卡信息 + 目标列表 + 确认出击

### 7.2 交互流程
1. 军营出击点交互 → 打开 MissionMap
2. 点击目的地图标 → 右侧弹出该区域任务面板
3. 选择任务 → 显示详情（含目标列表、污染预估、已完成标记）
4. 确认出击 → 进入关卡
5. 返回 → 收起面板 / 关闭地图

---

## 8. 已确认的编码规范

参见 `DOCUMENTS/注意事项.md`：
1. 不考虑存档兼容
2. 禁止 `:=` 类型推断
3. 禁止 preload 自身 .tscn
4. 尽量使用场景树子节点 + @onready，减少 _ready 中 new() + add_child()
